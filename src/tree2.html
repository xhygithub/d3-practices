<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tree</title>
    <!-- <link rel="stylesheet" type="text/css" href="../../css/styles.css"/> -->
    <script type="text/javascript" src="../../lib/d3.js"></script>
    <style type="text/css">
        .node circle {
            cursor: pointer;
            fill: red;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .node text {
            font-size: 11px;
        }

        path.link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }
    
    </style>
</head>

<body>

<script type="text/javascript">


function tree() {

    var instance = {}, config = {};
    var _margins = {top: 30, left: 120, right: 30, bottom: 30},
            _svg,
            _nodes = {},
            _i = 0,
            _tree,
            _diagonal,
            _bodyG;

    var max_branch = 30;
    var colors = d3.scale.linear().domain([0,max_branch]).range(["blue","orange"]);
    var colors2 = d3.scale.category10();
    var stroke_width = d3.scale.linear().domain([1,800]).range([5,50]);

    instance.config = function (myConfigs) {
        config = {
            _width:     myConfigs.svg_width || 200,
            _height:    myConfigs.svg_height || 1000,
            path:       myConfigs.path   || false
        };

        return instance;
    };


    instance.render = function () {
        if (!_svg) {
            _svg = d3.select("body").append("svg")
                    .attr("height", config._height)
                    .attr("width", config._width);
        }
        //add svg
        renderBody(_svg);
    };

    function renderBody(svg) {
        if (!_bodyG) {
            _bodyG = svg.append("g")
				.attr("class", "body")
				.attr("transform", function (d) {
					return "translate(" + _margins.left 
						+ "," + _margins.top + ")";
				});
        }

        _tree = d3.layout.tree()
                .size([
					(config._height - _margins.top - _margins.bottom), 
					(config._width - _margins.left - _margins.right)
				]);

        _diagonal = d3.svg.diagonal()
                .projection(function (d) {
                    return [d.y, d.x];
                });
// projection() 是一个点变换器，默认是 [ d.x , d.y ]，即保持原坐标不变，如果写成 [ d.y , d.x ] ，即是说对任意输入的顶点，都交换 x 和 y 坐标
//_nodes = data
        _nodes.x0 = (config._height - _margins.top - _margins.bottom) / 2;
        _nodes.y0 = 0;

        render(_nodes);
    }

    function render(source) {
        var nodes = _tree.nodes(_nodes).reverse();
        //获取每一个节点组成一个数组，倒排 array(33)
        renderNodes(nodes, source);

        renderLinks(nodes, source);
    }

    function renderNodes(nodes, source) {
        nodes.forEach(function (d) {
            // console.log('>',d);
            d.y = d.depth * 180;
            // console.log('>>',d.y);
        });

        var node = _bodyG.selectAll("g.node")
                .data(nodes, function (d) {
                    return d.id || (d.id = ++_i);
                });

        var nodeEnter = node.enter().append("svg:g")
                .attr("class", "node")
                .attr("transform", function (d) {
                    return "translate(" + source.y0 
						+ "," + source.x0 + ")";
                })
                .on("click", function (d) {
                    toggle(d);
                    render(d);
                });

        nodeEnter.append("svg:circle")
                .attr("r", 1e-6)
                .style("fill", function (d) {
                    return d._children ? "lightsteelblue" : "red";
                });

        var nodeUpdate = node.transition()
                .attr("transform", function (d) {
                    return "translate(" + d.y + "," + d.x + ")";
                });


        //点击hidden 字元素，父元素变黄
        nodeUpdate.select("circle")
                .attr("r", function (d) {
                    if(!config.path){ return 4.5;}
                    else{
                        
                        return d.number/20;
                    }
                })
                .style("fill", function (d) {
                    return d._children ? "yellow" : "red";
                });

        var nodeExit = node.exit().transition()
                .attr("transform", function (d) {
                    return "translate(" + source.y 
						+ "," + source.x + ")";
                })
                .remove();

        nodeExit.select("circle")
                .attr("r", 1e-6);

        renderLabels(nodeEnter, nodeUpdate, nodeExit);

        nodes.forEach(function (d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    function renderLabels(nodeEnter, nodeUpdate, nodeExit) {
        nodeEnter.append("svg:text")
                .attr("x", function (d) {
                    return d.children || d._children ? -10 : 10;
                })
                .attr("dy", ".35em")
                .attr("text-anchor", function (d) {
                    return d.children || d._children ? "end" : "start";
                })
                .text(function (d) {
                    return d.name;
                })
                .style("fill-opacity", 1e-6);

        nodeUpdate.select("text")
                .style("fill-opacity", 1);

        nodeExit.select("text")
                .style("fill-opacity", 1e-6);
    }

    function renderLinks(nodes, source) {
        var link = _bodyG.selectAll("path.link")
                .data(_tree.links(nodes), function (d) {
                    return d.target.id;
                });


        //returns an array of objects representing the links from parent to child for each node
        //two attributes "source","target"

        link.enter().insert("svg:path", "g")
                .attr("class", "link")
                .attr("d", 
                    // _diagonal
                    function (d) {
                    var o = {x: source.x0, y: source.y0};
                    return _diagonal({source: o, target: o});
                    }
                )
                .style({
                    "stroke":function (d, i) {
                        if(d.source.depth == 0){return colors(d.target.id); }
                        else{
                            var col = d3.interpolate(colors(d.source.id), d3.rgb(0,0,0));
                            //return a function [0,1] --[color]
                            var linear = d3.scale.linear().domain([0,400]).range([0,1]);
                            return col( linear(d.source.depth));
                        }
                    }
                    ,"opacity": 0.5
                        // ,"visibility":0.01
                    ,"stroke-width": function (d, i) { 
                        if(!config.path) return 2;
                        return stroke_width(d.target.number).toString();
                    }
                });
                

        link.transition()
                .attr("d", _diagonal);
                // .style("color","200px");

        link.exit().transition()
                .attr("d", function (d) {
                    var o = {x: source.x, y: source.y};
                    return _diagonal({source: o, target: o});
                })
                .remove();
    }

    function toggle (d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
    }

    function toggleAll (d) {
        if (d.children) {
            d.children.forEach(toggleAll);
            toggle(d);
        }
    }

    instance.width = function (w) {
        if (!arguments.length) return _width;
        _width = w;
        return instance;
    };

    instance.height = function (h) {
        if (!arguments.length) return _height;
        _height = h;
        return instance;
    };

    instance.margins = function (m) {
        if (!arguments.length) return _margins;
        _margins = m;
        return instance;
    };

    instance.nodes = function (n) {
        if (!arguments.length) return _nodes;
        _nodes = n;
        return instance;
    };

    return instance;
}





var UserData ={
 "name": "flare",
 "number":1000,
 "children": [
  {
   "name": "analytics",
   "number": 200,
   "children": [
    {
     "name": "cluster",
     "number": 100,
     "children": [
      {"name": "AgglomerativeCluster", "number": 80,"size": 3938},
      {"name": "CommunityStructure", "number": 100,"size": 3812},
      {"name": "MergeEdge", "number": 200, "size": 743}
     ]
    },
    {
     "name": "graph",
     "number": 200,
     "children": [
      {"name": "BetweennessCentrality", "number": 200,"size": 3534},
      {"name": "LinkDistance", "number": 200,"size": 5731}
     ]
    },
    {
     "name": "optimization",
     "number": 200,
     "children": [
      {"name": "AspectRatioBanker", "number": 200,"size": 7074}
     ]
    }
   ]
  },
  {
   "name": "animate",
   "number": 200,
   "children": [
    {"name": "Easing", "number": 200,"size": 17010},
    {"name": "FunctionSequence", "number": 200,"size": 5842},
    {
     "name": "interpolate",
     "number": 200,
     "children": [
      {"name": "ArrayInterpolator", "number": 200, "size": 1983},
      {"name": "ColorInterpolator", "number": 300,"size": 2047},
      {"name": "DateInterpolator", "number": 70, "size": 1375},
      {"name": "Interpolator", "number": 20, "size": 8746},
      {"name": "MatrixInterpolator", "number": 200,"size": 2202},
      {"name": "NumberInterpolator", "number": 200,"size": 1382},
      {"name": "ObjectInterpolator", "number": 200,"size": 1629},
      {"name": "PointInterpolator", "number": 200,"size": 1675},
      {"name": "RectangleInterpolator", "number": 2,"size": 2042}
     ]
    },
    {"name": "ISchedulable", "number": 80,"size": 1041},
    {"name": "Parallel", "number": 20,"size": 5176},
    {"name": "Pause", "number": 100,"size": 449},
    {"name": "Scheduler", "number": 200,"size": 5593},
    {"name": "Sequence", "number": 20,"size": 5534},
    {"name": "Transition", "number": 200,"size": 9201},
    {"name": "Transitioner", "number": 2,"size": 19975},
    {"name": "TransitionEvent", "number": 10,"size": 1116},
    {"name": "Tween", "number": 2,"size": 6006}
   ]
  }
 ]
}

// d3.json("../../data/simple-flare.json", function (data) {
//     UserData = data;
//     console.log(">",UserData);
// });


tree().nodes(UserData)
        .config({
            svg_width: 1600,
            svg_height: 800,
            path : true
        })
        .render();
</script>


</body>

</html>